name: Generate Hytale Documentation

on:
  workflow_dispatch:
    inputs:
      jar_url:
        description: 'JAR file URL (optional - uses JAR_DOWNLOAD_URL secret if not provided)'
        required: false
        type: string
      version_tag:
        description: 'Custom version tag (optional - uses git tag or commit SHA if not provided)'
        required: false
        type: string

jobs:
  build-documentation:
    name: Build Documentation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine-version.outputs.version }}
      jar_url: ${{ steps.determine-jar.outputs.jar_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Python 3.11+
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine version
        id: determine-version
        run: |
          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION="${{ inputs.version_tag }}"
          elif git describe --tags --exact-match 2>/dev/null; then
            VERSION=$(git describe --tags --exact-match)
          else
            VERSION="commit-$(git rev-parse --short=7 HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Determined version: $VERSION"

      - name: Determine JAR URL
        id: determine-jar
        run: |
          if [ -n "${{ inputs.jar_url }}" ]; then
            JAR_URL="${{ inputs.jar_url }}"
          else
            JAR_URL="${{ secrets.JAR_DOWNLOAD_URL }}"
          fi

          if [ -z "$JAR_URL" ]; then
            echo "Error: JAR URL not provided. Set JAR_DOWNLOAD_URL secret or provide jar_url input."
            exit 1
          fi

          echo "jar_url=$JAR_URL" >> $GITHUB_OUTPUT
          echo "Using JAR URL: $JAR_URL"

      - name: Download Hytale Server JAR
        run: |
          mkdir -p lib
          echo "Downloading JAR from: ${{ steps.determine-jar.outputs.jar_url }}"
          curl -L -o lib/HytaleServer.jar "${{ steps.determine-jar.outputs.jar_url }}"

          # Verify download
          if [ ! -f lib/HytaleServer.jar ]; then
            echo "Error: Failed to download JAR file"
            exit 1
          fi

          FILE_SIZE=$(stat -f%z lib/HytaleServer.jar 2>/dev/null || stat -c%s lib/HytaleServer.jar 2>/dev/null)
          echo "Downloaded JAR size: $FILE_SIZE bytes"

          if [ "$FILE_SIZE" -lt 1000 ]; then
            echo "Error: JAR file too small, download may have failed"
            exit 1
          fi

      - name: Generate documentation
        run: |
          echo "Running hydocs.py to generate documentation..."
          python3 hydocs.py --file lib/HytaleServer.jar --output build

          # Verify output
          if [ ! -f build/INDEX.md ]; then
            echo "Error: Documentation generation failed - INDEX.md not found"
            exit 1
          fi

          echo "Documentation generated successfully"
          echo "Files in build directory:"
          ls -lah build/ | head -20

      - name: Create version metadata
        run: |
          cat > build/VERSION.json << EOF
          {
            "version": "${{ steps.determine-version.outputs.version }}",
            "commit_sha": "${{ github.sha }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "jar_url": "${{ steps.determine-jar.outputs.jar_url }}",
            "build_number": "${{ github.run_number }}",
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF

          echo "Created VERSION.json:"
          cat build/VERSION.json

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hytale-documentation
          path: build/
          retention-days: 30

  deploy-to-s3:
    name: Deploy to S3
    runs-on: ubuntu-latest
    needs: build-documentation

    steps:
      - name: Download documentation artifacts
        uses: actions/download-artifact@v4
        with:
          name: hytale-documentation
          path: build/

      - name: Install MinIO Client
        run: |
          curl -O https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          sudo mv mc /usr/local/bin/
          mc --version

      - name: Configure S3 alias
        env:
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
        run: |
          if [ -z "$S3_ENDPOINT" ] || [ -z "$S3_ACCESS_KEY_ID" ] || [ -z "$S3_SECRET_ACCESS_KEY" ]; then
            echo "Error: S3 credentials not configured. Please set S3_ENDPOINT, S3_ACCESS_KEY_ID, and S3_SECRET_ACCESS_KEY secrets."
            exit 1
          fi

          echo "Configuring MinIO client..."
          mc alias set s3storage "$S3_ENDPOINT" "$S3_ACCESS_KEY_ID" "$S3_SECRET_ACCESS_KEY"

          # Test connection
          mc ls s3storage/${{ secrets.S3_BUCKET }}/ || mc mb s3storage/${{ secrets.S3_BUCKET }}/

      - name: Upload versioned documentation
        env:
          VERSION: ${{ needs.build-documentation.outputs.version }}
        run: |
          echo "Uploading to s3storage/${{ secrets.S3_BUCKET }}/versions/$VERSION/"
          mc cp --recursive build/ s3storage/${{ secrets.S3_BUCKET }}/versions/$VERSION/

          echo "Upload completed successfully"

      - name: Update latest version
        run: |
          echo "Updating latest/ to point to newest build..."

          # Remove old latest (ignore errors if doesn't exist)
          mc rm --recursive --force s3storage/${{ secrets.S3_BUCKET }}/latest/ 2>/dev/null || true

          # Copy new latest
          mc cp --recursive build/ s3storage/${{ secrets.S3_BUCKET }}/latest/

          echo "Latest version updated successfully"

      - name: Set public access
        env:
          VERSION: ${{ needs.build-documentation.outputs.version }}
        run: |
          echo "Setting public download access..."

          # Set public access for latest
          mc anonymous set download s3storage/${{ secrets.S3_BUCKET }}/latest/

          # Set public access for versioned build
          mc anonymous set download s3storage/${{ secrets.S3_BUCKET }}/versions/$VERSION/

          echo "Public access configured successfully"

      - name: Generate versions list
        env:
          VERSION: ${{ needs.build-documentation.outputs.version }}
        run: |
          # List all versions
          echo "Generating versions.json..."

          # Get list of version directories
          VERSIONS=$(mc ls s3storage/${{ secrets.S3_BUCKET }}/versions/ | awk '{print $NF}' | sed 's#/##g' | jq -R -s -c 'split("\n")[:-1]')

          # Create versions.json
          cat > versions.json << EOF
          {
            "latest": "$VERSION",
            "updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "versions": $VERSIONS
          }
          EOF

          echo "Generated versions.json:"
          cat versions.json

          # Upload versions.json
          mc cp versions.json s3storage/${{ secrets.S3_BUCKET }}/versions.json
          mc anonymous set download s3storage/${{ secrets.S3_BUCKET }}/versions.json

      - name: Generate job summary
        env:
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          VERSION: ${{ needs.build-documentation.outputs.version }}
          JAR_URL: ${{ needs.build-documentation.outputs.jar_url }}
        run: |
          # Clean endpoint URL (remove trailing slash)
          ENDPOINT_CLEAN=$(echo "$S3_ENDPOINT" | sed 's#/$##')

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Hytale Documentation Published

          ## Build Information

          - **Version**: \`$VERSION\`
          - **Commit**: \`${{ github.sha }}\`
          - **Build Number**: \`${{ github.run_number }}\`
          - **JAR Source**: \`$JAR_URL\`

          ## Public URLs

          ### Latest Version (Stable URL)
          - **Index**: [$ENDPOINT_CLEAN/$S3_BUCKET/latest/INDEX.md]($ENDPOINT_CLEAN/$S3_BUCKET/latest/INDEX.md)
          - **Class Lookup**: [$ENDPOINT_CLEAN/$S3_BUCKET/latest/class_lookup.json]($ENDPOINT_CLEAN/$S3_BUCKET/latest/class_lookup.json)
          - **Version Info**: [$ENDPOINT_CLEAN/$S3_BUCKET/latest/VERSION.json]($ENDPOINT_CLEAN/$S3_BUCKET/latest/VERSION.json)

          ### This Build (Versioned)
          - **Index**: [$ENDPOINT_CLEAN/$S3_BUCKET/versions/$VERSION/INDEX.md]($ENDPOINT_CLEAN/$S3_BUCKET/versions/$VERSION/INDEX.md)
          - **Class Lookup**: [$ENDPOINT_CLEAN/$S3_BUCKET/versions/$VERSION/class_lookup.json]($ENDPOINT_CLEAN/$S3_BUCKET/versions/$VERSION/class_lookup.json)

          ### All Versions
          - **Versions List**: [$ENDPOINT_CLEAN/$S3_BUCKET/versions.json]($ENDPOINT_CLEAN/$S3_BUCKET/versions.json)

          ## MCP Configuration

          Configure your MCP server to use:
          \`\`\`
          $ENDPOINT_CLEAN/$S3_BUCKET/latest/class_lookup.json
          \`\`\`

          ## Next Steps

          1. Test the documentation by opening the Index URL above
          2. Verify class_lookup.json is valid JSON
          3. Update your MCP server configuration if needed
          4. Share the documentation URL with your team

          ---
          *Generated by [Hydocs GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF

          echo "Job summary generated successfully"
